//>>built
var __extends=this&&this.__extends||function(){var n=function(f,h){n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,f){d.__proto__=f}||function(d,f){for(var h in f)f.hasOwnProperty(h)&&(d[h]=f[h])};return n(f,h)};return function(f,h){function d(){this.constructor=f}n(f,h);f.prototype=null===h?Object.create(h):(d.prototype=h.prototype,new d)}}(),__decorate=this&&this.__decorate||function(n,f,h,d){var u=arguments.length,m=3>u?f:null===d?d=Object.getOwnPropertyDescriptor(f,h):d,t;
if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)m=Reflect.decorate(n,f,h,d);else for(var x=n.length-1;0<=x;x--)if(t=n[x])m=(3>u?t(m):3<u?t(f,h,m):t(f,h))||m;return 3<u&&m&&Object.defineProperty(f,h,m),m};
define("require exports esri/core/tsSupport/declareExtendsHelper esri/core/tsSupport/decorateHelper esri/widgets/support/widget esri/tasks/support/FeatureSet esri/core/Accessor esri/core/watchUtils esri/Graphic esri/tasks/IdentifyTask esri/tasks/support/IdentifyParameters esri/geometry/SpatialReference esri/layers/support/LabelClass esri/layers/FeatureLayer esri/renderers/SimpleRenderer esri/symbols/PolygonSymbol3D esri/geometry/Point esri/geometry/geometryEngine esri/geometry/Polyline esri/tasks/support/Query esri/tasks/Geoprocessor dojo/_base/array dojo/dom-class dojo/promise/all dojo/Deferred esri/core/accessorSupport/decorators".split(" "),function(n,
f,h,d,u,m,t,x,y,F,G,H,B,D,I,J,v,K,L,M,N,C,O,z,p,k){Object.defineProperty(f,"__esModule",{value:!0});var r=new H({wkid:103142});n={type:"web-style",styleName:"EsriThematicShapesStyle",name:"Centered Sphere"};var P=new y({symbol:n});B=new B({labelExpressionInfo:{expression:"$feature.surfaceName"},labelPlacement:"above-after",symbol:{type:"text",color:"black",haloSize:1,haloColor:"white"}});var E=new D({id:"surface_intersection",title:"Surface Intersection Point",visible:!1,fields:[{name:"ObjectID",
alias:"ObjectID",type:"oid"},{name:"surfaceName",alias:"Surface Name",type:"text"}],objectIdField:"ObjectID",geometryType:"point",spatialReference:r,elevationInfo:{mode:"absolute-height"},source:[],legendEnabled:!1,renderer:{type:"simple",symbol:n},labelingInfo:[B],labelsVisible:!1,popupEnabled:!0});new y({symbol:{type:"point-3d",symbolLayers:[{type:"object",width:5,height:100,depth:5,resource:{primitive:"cylinder"},material:{color:"blue"}}]}});var A=new D({id:"obstruction_base",title:"Placed Obstruction",
opacity:.5,fields:[{name:"ObjectID",alias:"ObjectID",type:"oid"},{name:"baseElevation",alias:"Base Elevation",type:"double"},{name:"obstacleHeight",alias:"Obstacle Height",type:"double"}],objectIdField:"ObjectID",geometryType:"polygon",spatialReference:r,elevationInfo:{mode:"on-the-ground"},source:[],legendEnabled:!1,renderer:new I({symbol:new J({symbolLayers:[{type:"extrude",width:5,depth:5,resource:{primitive:"cylinder"},material:{color:"blue"}}]}),visualVariables:[{type:"size",field:"obstacleHeight",
valueUnit:"feet"}]})});t=function(f){function c(a){a=f.call(this,a)||this;x.whenOnce(a,"view").then(a.onload.bind(a));return a}h(c,f);c.prototype.toggleActivation=function(a){O.toggle(a.srcElement,"btn-clear");this.activated=this.activated?!1:!0};c.prototype.activate=function(){var a=this,b=this.scene.findLayerById("critical_3d"),g=this.scene.findLayerById("part_77_group"),e=this.scene.findLayerById("critical_2d_surfaces"),c=this.scene.findLayerById("surface_intersection");b&&(b.visible=!1,b.layers.forEach(function(a){a.definitionExpression=
"OBJECTID IS NULL"}));g&&(g.visible=!1,g.layers.forEach(function(a){a.definitionExpression="OBJECTID IS NULL"}));c&&(c.source.removeAll(),this.scene.remove(c));e&&(e.visible=!1,e.definitionExpression="OBJECTID IS NULL");var q=document.getElementById("groundLevel");document.getElementById("obsHeight");this.mouse_track=this.view.on("pointer-move",function(b){(b=a.view.toMap({x:b.x,y:b.y}))&&a.scene.ground.queryElevation(b).then(function(a){q.value=a.geometry.z.toFixed(2)})});this.view_click=this.view.on("click",
function(b){a.activated=!1;b.stopPropagation();b&&b.mapPoint&&(a.modifiedBase=!1,a.scene.ground.queryElevation(b.mapPoint).then(function(b){a.submit(new v({x:b.geometry.x,y:b.geometry.y,z:b.geometry.z}))}))})};c.prototype.deactivate=function(){this.mouse_track&&this.mouse_track.remove();this.view_click&&this.view_click.remove();this.view.graphics.removeAll()};c.prototype.ccXY=function(){var a=new p,b=this.ccWidgetViewModel.get("conversions").getItemAt(0),g;"basemap"===b.format.name?(g=b.position.location.x,
b=b.position.location.y,a.resolve({x:g,y:b})):this.ccWidgetViewModel.reverseConvert(b.position.coordinate,b.format).then(function(b){a.resolve({x:b.x,y:b.y})});return a.promise};c.prototype.submit=function(a){var b=new p,g=document.getElementById("obsHeight"),e=document.getElementById("groundLevel"),c=a.z.toFixed(2);e.value=c;e=parseFloat(g.value);e||(e=200-Number(c),g.value=e.toFixed(2));a=this.addObstructionGraphic(a.x,a.y,a.z,e);this.performQuery(a).then(function(a){b.resolve(a)});return b.promise};
c.prototype.addObstructionGraphic=function(a,b,g,e){a=new v({x:a,y:b,z:g,spatialReference:r});a=K.buffer(a,25,"feet");b=new y;b.attributes={ObjectID:0,baseElevation:g,obstacleHeight:e};b.geometry=a;b.geometry.spatialReference=r;A.source.removeAll();A.source.add(b);this.scene.add(A);this.scene.add(E);return b};c.prototype.performQuery=function(a){var b=this,g=new p,e=a.attributes.obstacleHeight,c=a.geometry,q=c.centroid.x,l=c.centroid.y,c=new L({paths:[[[q,l,a.attributes.baseElevation],[q+1,l+1,e]]],
spatialReference:r,hasZ:!0});this.doIdentify(q,l).then(function(a){if(a){a=b.buildObstructionSettings(a);if(!b.modifiedBase){var g=a.groundElevation;document.getElementById("groundLevel").value=g.toString();b.groundElevation=g}g=Number((b.groundElevation+e).toFixed(2));e=Number(e.toFixed(2));q=Number(q.toFixed(2));l=Number(l.toFixed(2));b.results.set({x:q,y:l,msl:g,agl:e,modifiedBase:b.modifiedBase,layerResults3d:a.layerResults3d,layerResults2d:a.layerResults2d,groundElevation:b.groundElevation,dem_source:a.dem_source});
b.results.expand.expand()}else console.log("No results from server :: "+a)});this.querySurfaces(c).then(function(){b.view.whenLayerView(A).then(function(c){c.highlight(a);b.view.goTo(a.geometry.extent.center);b.setDefaultLayerVisibility();g.resolve(a)})});return g.promise};c.prototype.submitPanel=function(a){var b=this;document.getElementById("obsHeight");a=document.getElementById("groundLevel");a=parseFloat(a.value);a!==this.groundElevation?this.modifiedBase=!0:this.modifiedBase?console.log("the base has already been modified once"):
this.modifiedBase=!1;this.groundElevation=a;this.ccXY().then(function(a){a=new v({x:a[0],y:a[1],z:b.groundElevation,spatialReference:r});b.submit(a)})};c.prototype.querySurfaces=function(a){function b(a,b,c){return a?!1:!0}var g=this.scene,c=new p,f=new p,q=new p,l=new p,d=g.findLayerById("critical_3d"),h=d.layers,k=g.findLayerById("part_77_group"),n=k.layers,w=g.findLayerById("runwayhelipaddesignsurface"),m=new M({geometry:a,units:"feet",spatialRelationship:"intersects",returnGeometry:!0,outFields:["*"],
returnZ:!0});a=C.map(h.items,function(a){var b=new p;a.queryFeatures(m).then(function(c){c.features.length?(c=c.features.map(function(a){return a.attributes.OBJECTID}),a.definitionExpression=1<c.length?"OBJECTID IN ("+c.join()+")":1===c.length&&void 0!==c[0]?"OBJECTID \x3d "+c[0]:"OBJECTID IS NULL",b.resolve(c)):(a.definitionExpression="OBJECTID IS NULL",b.resolve(!1))},function(a){console.log(a);b.resolve(!1)});return b.promise});z(a).then(function(a){a.every(b)?(d.visible=!1,f.resolve(!1)):(d.visible=
!0,f.resolve(!0))});n=C.map(n.items,function(a){var b=new p;a.queryFeatures(m).then(function(c){c.features.length?(c=c.features.map(function(a){return a.attributes.OBJECTID}))?(a.definitionExpression=1<c.length?"OBJECTID IN ("+c.join()+")":1===c.length&&void 0!==c[0]?"OBJECTID \x3d "+c[0]:"OBJECTID IS NULL",b.resolve(c)):(a.definitionExpression="OBJECTID IS NULL",b.resolve(!1)):(a.definitionExpression="OBJECTID IS NULL",b.resolve(!1))},function(a){console.log(a);b.resolve(!1)});return b.promise});
z(n).then(function(a){a.every(b)?(k.visible=!1,q.resolve(!1)):(k.visible=!0,q.resolve(!0))});w.queryFeatures(m).then(function(a){a.features.length?(a=a.features.map(function(a){return a.attributes.OBJECTID}),w.definitionExpression="OBJECTID IN ("+a.join()+")",w.visible=!0,l.resolve(!0)):(w.definitionExpression="OBJECTID IS NULL",w.visible=!1,l.resolve(!1))},function(a){console.log(a);w.visible=!1;l.resolve(!1)});z([f,q,l]).then(function(a){a[0]||a[1]||a[2]?c.resolve(!0):c.resolve(!1)});return c.promise};
c.prototype.getIntersectionPoint=function(a,b){var c=new p;b=new v({x:b.paths[0][0][0],y:b.paths[0][0][1],spatialReference:r});a=new N({url:"http://gis.aroraengineers.com/arcgis/rest/services/PHL/Intersect3DLineWithOIS/GPServer/Intersect%203D%20Line%20With%20Multipatch"});b=new y({geometry:b,attributes:[{OBJECTID:0},{SHAPE_Length:line_length}]});var e=new m;e.geometryType="polyline";e.features=[b];a.execute({in_line_features:e,in_multipatch_features:"OIS"}).then(function(a){console.log(a);c.resolve(a)},
function(a){console.log(a);c.resolve(!1)});return c.promise};c.prototype.filterSurfaces3D=function(a,b){var c=this,e=new p,f=b.paths[0][1][2];a=C.map(a.features,function(a){var g=new p;c.getIntersectionPoint(a,b).then(function(b){if(b&&b.z<=f){var c=P.clone();b=new v(b);b.spatialReference=r;c.geometry=b;c.attributes={surfaceName:a.attributes.NAME};E.source.add(c);g.resolve(a.attributes.OBJECTID)}else g.resolve()},function(a){console.log(a);g.resolve()});return g.promise});z(a).then(function(a){e.resolve(a)});
return e.promise};c.prototype.doIdentify=function(a,b){var c=this.view,e=new p,f=new F({url:"http://gis.aroraengineers.com/arcgis/rest/services/PHL/Surfaces/MapServer"}),d=new G;d.tolerance=1;d.returnGeometry=!0;d.layerOption="all";d.mapExtent=c.extent;d.geometry=new v({x:a,y:b,spatialReference:r});f.execute(d).then(function(a){a=a.results;console.log(a);e.resolve(a)},function(a){console.log(a)});return e.promise};c.prototype.setDefaultLayerVisibility=function(){var a=this,b=0;this.scene.allLayers.forEach(function(c){"feature"===
c.type&&(c={id:c.id,def_visible:c.visible,def_exp:c.definitionExpression},b?a.layerVisibility?a.layerVisibility.push(c):a.layerVisibility=[c]:(a.layerVisibility=[c],b+=1))})};c.prototype.buildObstructionSettings=function(a){for(var b=[],c=[],e=!1,d=0,f=a.length;d<f;d++){var l=a[d],h=void 0,k=void 0,n=void 0;if(-1!==[1,2,3,4,6,7,8].indexOf(l.layerId)){var h=l.feature.attributes.Name,k=l.feature.attributes["Runway Designator"].replace("/","_"),n=l.feature.attributes.OBJECTID,m=l.feature.clone();m.attributes.layerName=
l.layerName;m.attributes.Elev=void 0;h=h+"_"+k+"_"+n;k=0;for(n=a.length;k<n;k++)if(a[k].layerName===h){var p=a[k].feature.attributes["Pixel Value"];"NoData"===p?console.log(h):(p=parseFloat(p).toFixed(1),m.attributes.Elev=parseFloat(p),b.push(m))}}-1!==[10,11].indexOf(l.layerId)&&(m=l.feature.clone(),m.attributes.layerName=l.layerName,c.push(m));82===l.layerId&&(e=l.feature.attributes["Pixel Value"],this.modifiedBase?e=!1:"NoData"===e?e=!1:(this.groundElevation=parseFloat(parseFloat(e).toFixed(1)),
e=!0))}return{layerResults2d:{displayFieldName:"Name",features:c},layerResults3d:{displayFieldName:"Name",features:b},dem_source:e?"PHL DEM":this.modifiedBase?"Manual Override":"USGS DEM",groundElevation:this.groundElevation}};c.prototype.onload=function(){};d([k.property()],c.prototype,"scene",void 0);d([k.property()],c.prototype,"view",void 0);d([u.renderable(),k.property()],c.prototype,"name",void 0);d([k.property()],c.prototype,"groundElevation",void 0);d([k.property()],c.prototype,"activated",
void 0);d([k.property()],c.prototype,"layerVisibility",void 0);d([k.property()],c.prototype,"modifiedBase",void 0);d([k.property()],c.prototype,"ccWidgetViewModel",void 0);d([k.property()],c.prototype,"results",void 0);d([k.property()],c.prototype,"mouse_track",void 0);d([k.property()],c.prototype,"view_click",void 0);return c=d([k.subclass("widgets.App.ObstructionViewModel")],c)}(k.declared(t));f.default=t});