//>>built
var __extends=this&&this.__extends||function(){var n=function(k,h){n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(a,f){a.__proto__=f}||function(a,f){for(var g in f)f.hasOwnProperty(g)&&(a[g]=f[g])};return n(k,h)};return function(k,h){function a(){this.constructor=k}n(k,h);k.prototype=null===h?Object.create(h):(a.prototype=h.prototype,new a)}}(),__decorate=this&&this.__decorate||function(n,k,h,a){var f=arguments.length,g=3>f?k:null===a?a=Object.getOwnPropertyDescriptor(k,h):a,l;
if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)g=Reflect.decorate(n,k,h,a);else for(var b=n.length-1;0<=b;b--)if(l=n[b])g=(3>f?l(g):3<f?l(k,h,g):l(k,h))||g;return 3<f&&g&&Object.defineProperty(k,h,g),g},__awaiter=this&&this.__awaiter||function(n,k,h,a){return new (h||(h=Promise))(function(f,g){function l(b){try{p(a.next(b))}catch(r){g(r)}}function b(b){try{p(a["throw"](b))}catch(r){g(r)}}function p(a){a.done?f(a.value):(new h(function(b){b(a.value)})).then(l,b)}p((a=a.apply(n,
k||[])).next())})},__generator=this&&this.__generator||function(n,k){function h(b){return function(f){return a([b,f])}}function a(a){if(g)throw new TypeError("Generator is already executing.");for(;f;)try{if(g=1,l&&(b=a[0]&2?l["return"]:a[0]?l["throw"]||((b=l["return"])&&b.call(l),0):l.next)&&!(b=b.call(l,a[1])).done)return b;if(l=0,b)a=[a[0]&2,b.value];switch(a[0]){case 0:case 1:b=a;break;case 4:return f.label++,{value:a[1],done:!1};case 5:f.label++;l=a[1];a=[0];continue;case 7:a=f.ops.pop();f.trys.pop();
continue;default:if(!(b=f.trys,b=0<b.length&&b[b.length-1])&&(6===a[0]||2===a[0])){f=0;continue}if(3===a[0]&&(!b||a[1]>b[0]&&a[1]<b[3]))f.label=a[1];else if(6===a[0]&&f.label<b[1])f.label=b[1],b=a;else if(b&&f.label<b[2])f.label=b[2],f.ops.push(a);else{b[2]&&f.ops.pop();f.trys.pop();continue}}a=k.call(n,f)}catch(r){a=[6,r],l=0}finally{g=b=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}var f={label:0,sent:function(){if(b[0]&1)throw b[1];return b[1]},trys:[],ops:[]},g,l,b,p;return p=
{next:h(0),"throw":h(1),"return":h(2)},"function"===typeof Symbol&&(p[Symbol.iterator]=function(){return this}),p};
define("require exports esri/core/tsSupport/declareExtendsHelper esri/core/tsSupport/decorateHelper esri/widgets/support/widget esri/core/Accessor esri/core/watchUtils esri/Graphic esri/tasks/IdentifyTask esri/tasks/support/IdentifyParameters esri/geometry/SpatialReference esri/layers/support/LabelClass esri/layers/FeatureLayer esri/renderers/SimpleRenderer esri/symbols/PolygonSymbol3D esri/geometry/Point esri/geometry/geometryEngine esri/geometry/Polyline esri/tasks/support/Query dojo/_base/array dojo/dom-class dojo/promise/all dojo/Deferred esri/core/accessorSupport/decorators".split(" "),function(n,
k,h,a,f,g,l,b,p,C,r,y,A,D,E,v,F,G,H,B,z,w,q,m){Object.defineProperty(k,"__esModule",{value:!0});var t=new r({wkid:103142});n={type:"web-style",styleName:"EsriThematicShapesStyle",name:"Centered Sphere"};new b({symbol:n});y=new y({labelExpressionInfo:{expression:"$feature.surfaceName"},labelPlacement:"above-after",symbol:{type:"text",color:"black",haloSize:1,haloColor:"white"}});var I=new A({id:"surface_intersection",title:"Surface Intersection Point",visible:!1,fields:[{name:"ObjectID",alias:"ObjectID",
type:"oid"},{name:"surfaceName",alias:"Surface Name",type:"text"}],objectIdField:"ObjectID",geometryType:"point",spatialReference:t,elevationInfo:{mode:"absolute-height"},source:[],legendEnabled:!1,renderer:{type:"simple",symbol:n},labelingInfo:[y],labelsVisible:!1,popupEnabled:!0});new b({symbol:{type:"point-3d",symbolLayers:[{type:"object",width:5,height:100,depth:5,resource:{primitive:"cylinder"},material:{color:"blue"}}]}});var x=new A({id:"obstruction_base",title:"Placed Obstruction",opacity:.5,
fields:[{name:"ObjectID",alias:"ObjectID",type:"oid"},{name:"baseElevation",alias:"Base Elevation",type:"double"},{name:"obstacleHeight",alias:"Obstacle Height",type:"double"}],objectIdField:"ObjectID",geometryType:"polygon",spatialReference:t,elevationInfo:{mode:"on-the-ground"},source:[],legendEnabled:!1,renderer:new D({symbol:new E({symbolLayers:[{type:"extrude",width:5,depth:5,resource:{primitive:"cylinder"},material:{color:"blue"}}]}),visualVariables:[{type:"size",field:"obstacleHeight",valueUnit:"feet"}]})});
g=function(g){function e(d){d=g.call(this,d)||this;l.whenOnce(d,"view").then(d.onload.bind(d));return d}h(e,g);e.prototype.toggleActivation=function(d){z.toggle(d.srcElement,"btn-clear");this.activated=this.activated?!1:!0};e.prototype.clearLayers=function(){return __awaiter(this,void 0,void 0,function(){var d,a,b,c;return __generator(this,function(f){d=this.scene.findLayerById("critical_3d");a=this.scene.findLayerById("part_77_group");b=this.scene.findLayerById("critical_2d_surfaces");c=this.scene.findLayerById("surface_intersection");
d&&(d.visible=!1,d.layers.forEach(function(a){a.definitionExpression="OBJECTID IS NULL";a.visible=!1}));a&&(a.visible=!1,a.layers.forEach(function(a){a.definitionExpression="OBJECTID IS NULL";a.visible=!1}));c&&(c.source.removeAll(),this.scene.remove(c));b&&(b.visible=!1,b.definitionExpression="OBJECTID IS NULL");this.results.highlight2d&&this.results.highlight2d.remove();return[2]})})};e.prototype.activate=function(){var a=this;this.clearLayers();this.ccWidget&&(this.ccWidget.mode="live");this.disableSubmitPanel();
var b=document.getElementById("groundLevel");document.getElementById("obsHeight");this.mouse_track=this.view.on("pointer-move",function(d){(d=a.view.toMap({x:d.x,y:d.y}))&&a.scene.ground.queryElevation(d).then(function(a){b.value=a.geometry.z.toFixed(2)})});this.view_click=this.view.on("click",function(d){a.activated=!1;d.stopPropagation();d&&d.mapPoint&&(a.modifiedBase=!1,a.scene.ground.queryElevation(d.mapPoint).then(function(d){var b=d.geometry.x,c=d.geometry.y;d=d.geometry.z;a.demGroundElevation=
d;a.submit(new v({x:b,y:c,z:d})).then(function(d){a.enableSubmitPanel()})}))})};e.prototype.disableSubmitPanel=function(){var a=document.getElementById("obs_submit");z.add(a,"btn-disabled")};e.prototype.enableSubmitPanel=function(){var a=document.getElementById("obs_submit");z.remove(a,"btn-disabled")};e.prototype.deactivate=function(){this.mouse_track&&this.mouse_track.remove();this.view_click&&this.view_click.remove();this.ccWidget&&(this.ccWidget.mode="capture")};e.prototype.submit=function(a){var d=
new q,b=document.getElementById("obsHeight"),c=a.y.toFixed(2);this.y_coordinate=parseFloat(c);c=a.x.toFixed(2);this.x_coordinate=parseFloat(c);c=parseFloat(b.value);c||(c=this.modifiedBase?200-this.userGroundElevation:200-this.demGroundElevation,b.value=c.toFixed(2));this.obstructionHeight=parseFloat(parseFloat(b.value).toFixed(2));a=this.addObstructionGraphic(a.x,a.y,a.z,this.obstructionHeight);this.performQuery(a).then(function(a){d.resolve(a)});return d.promise};e.prototype.addObstructionGraphic=
function(a,f,e,c){a=new v({x:a,y:f,z:e,spatialReference:t});a=F.buffer(a,25,"feet");f=c;this.modifiedBase&&(f=c+(this.userGroundElevation-this.demGroundElevation));c=new b;c.attributes={ObjectID:0,baseElevation:e,obstacleHeight:f};c.geometry=a;c.geometry.spatialReference=t;x.source.removeAll();x.source.add(c);this.scene.add(x);this.scene.add(I);return c};e.prototype.performQuery=function(a){var b=this,d=new q,c=new q,f=new q,e=a.attributes.obstacleHeight,u=a.geometry,g=u.centroid.x,h=u.centroid.y,
u=new G({paths:[[[g,h,a.attributes.baseElevation],[g+1,h+1,e]]],spatialReference:t,hasZ:!0});this.doIdentify(g,h).then(function(a){if(a){a=b.buildObstructionSettings(a);var d=void 0,c=void 0;b.modifiedBase?b.userGroundElevation?(d=b.userGroundElevation,c=d-b.demGroundElevation):console.log("user ground elevation not set with a modified Base"):(d=a.ground_elevation,d!==b.demGroundElevation&&console.log("ground elevation in buildObstructionSettings not completed properly"),document.getElementById("groundLevel").value=
d.toFixed(2));var u=Number((d+e).toFixed(2));e=Number(e.toFixed(2));g=Number(g.toFixed(2));h=Number(h.toFixed(2));a={x:g,y:h,msl:u,agl:e,modifiedBase:b.modifiedBase,layerResults3d:a.layerResults3d,layerResults2d:a.layerResults2d,ground_elevation:d,elevation_change:c,dem_source:a.dem_source};b.results.set(a);b.results.expand.expand();f.resolve(a)}else console.log("No results from server :: "+a),f.resolve(!1)});this.querySurfaces(u).then(function(){b.view.whenLayerView(x).then(function(d){d.highlight(a);
b.view.goTo(a.geometry.extent.center);b.setDefault3DLayerVisibility();b.results.defaultLayerVisibility=b.layerVisibility;c.resolve(a)})});w([c,f]).then(function(a){d.resolve(a)});return d.promise};e.prototype.submitPanel=function(a){document.getElementById("obsHeight");a=document.getElementById("groundLevel");this.clearLayers();this.userGroundElevation=parseFloat(parseFloat(a.value).toFixed(2));this.userGroundElevation!==this.demGroundElevation?this.modifiedBase=!0:(this.modifiedBase&&console.log("the base has already been modified once"),
this.modifiedBase=!1);a=new v({x:this.x_coordinate,y:this.y_coordinate,z:this.userGroundElevation,spatialReference:t});this.submit(a)};e.prototype.querySurfaces=function(a){function b(a,b,d){return a?!1:!0}var d=this,c=this.scene,f=new q,e=new q,g=new q,h=new q,k=c.findLayerById("critical_3d"),l=k.layers,m=c.findLayerById("part_77_group"),n=m.layers,p=c.findLayerById("runwayhelipaddesignsurface"),r=new H({geometry:a,units:"feet",spatialRelationship:"intersects",returnGeometry:!0,outFields:["*"],returnZ:!0});
a=B.map(l.items,function(a){var b=new q;a.queryFeatures(r).then(function(c){c.features.length?(c=c.features.map(function(a){return a.attributes.OBJECTID}),1<c.length?(a.definitionExpression="OBJECTID IN ("+c.join()+")",a.visible=!0):1===c.length&&void 0!==c[0]?(a.definitionExpression="OBJECTID \x3d "+c[0],a.visible=!0):(a.definitionExpression="OBJECTID IS NULL",a.visible=!1),b.resolve(c)):(a.definitionExpression="OBJECTID IS NULL",a.visible=!1,b.resolve(!1));d.results.viewModel.set3DSymbols(a,!1)},
function(a){console.log(a);k.visible=!1;b.resolve(!1)});return b.promise});w(a).then(function(a){a.every(b)?(k.visible=!1,e.resolve(!1)):(k.visible=!0,e.resolve(!0))});n=B.map(n.items,function(a){var b=new q;a.queryFeatures(r).then(function(c){c.features.length?(c=c.features.map(function(a){return a.attributes.OBJECTID}))?(1<c.length?(a.definitionExpression="OBJECTID IN ("+c.join()+")",a.visible=!0):1===c.length&&void 0!==c[0]?(a.definitionExpression="OBJECTID \x3d "+c[0],a.visible=!0):(a.definitionExpression=
"OBJECTID IS NULL",a.visible=!1),b.resolve(c)):(a.definitionExpression="OBJECTID IS NULL",a.visible=!1,b.resolve(!1)):(a.definitionExpression="OBJECTID IS NULL",a.visible=!1,b.resolve(!1));d.results.viewModel.set3DSymbols(a,!1)},function(a){console.log(a);m.visible=!1;b.resolve(!1)});return b.promise});w(n).then(function(a){a.every(b)?(m.visible=!1,g.resolve(!1)):(m.visible=!0,g.resolve(!0))});p.queryFeatures(r).then(function(a){a.features.length?(a=a.features.map(function(a){return a.attributes.OBJECTID}),
p.definitionExpression="OBJECTID IN ("+a.join()+")",p.visible=!0,h.resolve(!0)):(p.definitionExpression="OBJECTID IS NULL",p.visible=!1,h.resolve(!1))},function(a){console.log(a);p.visible=!1;h.resolve(!1)});w([e,g,h]).then(function(a){a[0]||a[1]||a[2]?f.resolve(!0):f.resolve(!1)});return f.promise};e.prototype.doIdentify=function(a,b){var d=this.view,c=new q,f=new p({url:"http://gis.aroraengineers.com/arcgis/rest/services/PHL/Surfaces/MapServer"}),e=new C;e.tolerance=1;e.returnGeometry=!0;e.layerOption=
"all";e.mapExtent=d.extent;e.geometry=new v({x:a,y:b,spatialReference:t});f.execute(e).then(function(a){a=a.results;console.log(a);c.resolve(a)},function(a){console.log(a)});return c.promise};e.prototype.setDefault3DLayerVisibility=function(){var a=this,b=0;["critical_3d","part_77_group"].forEach(function(d){new q;a.scene.findLayerById(d).layers.forEach(function(c){"feature"===c.type&&c.visible&&(c={id:c.id,def_visible:c.visible,def_exp:c.definitionExpression},b?a.layerVisibility.length&&a.layerVisibility.push(c):
(a.layerVisibility=[c],b+=1))})});return this.layerVisibility.length};e.prototype.buildObstructionSettings=function(a){for(var b=[],d=[],c=!1,e=0,f=a.length;e<f;e++){var g=a[e],h=void 0,k=void 0,m=void 0;if(-1!==[1,2,3,4,6,7,8].indexOf(g.layerId)){var h=g.feature.attributes.Name,k=g.feature.attributes["Runway Designator"].replace("/","_"),m=g.feature.attributes.OBJECTID,l=g.feature.clone();l.attributes.layerName=g.layerName;l.attributes.Elev=void 0;"Null"===g.feature.attributes["Runway Designator"]&&
(l.attributes["Runway Designator"]="n/a");h=h+"_"+k+"_"+m;k=0;for(m=a.length;k<m;k++)if(a[k].layerName===h){var n=a[k].feature.attributes["Pixel Value"];"NoData"===n?console.log(h):(n=parseFloat(n).toFixed(1),l.attributes.Elev=parseFloat(n),b.push(l))}}-1!==[10,11].indexOf(g.layerId)&&(l=g.feature.clone(),l.attributes.layerName=g.layerName,d.push(l));82===g.layerId&&(c=g.feature.attributes["Pixel Value"],this.modifiedBase?c=!1:"NoData"===c?c=!1:(this.demGroundElevation=parseFloat(parseFloat(c).toFixed(2)),
c=!0))}return{layerResults2d:{displayFieldName:"Name",features:d},layerResults3d:{displayFieldName:"Name",features:b},dem_source:c?"PHL DEM":this.modifiedBase?"Manual Override":"USGS DEM",ground_elevation:this.demGroundElevation}};e.prototype.onload=function(){};a([m.property()],e.prototype,"scene",void 0);a([m.property()],e.prototype,"view",void 0);a([f.renderable(),m.property()],e.prototype,"name",void 0);a([f.renderable(),m.property()],e.prototype,"demGroundElevation",void 0);a([f.renderable(),
m.property()],e.prototype,"userGroundElevation",void 0);a([m.property()],e.prototype,"obstructionHeight",void 0);a([m.property()],e.prototype,"x_coordinate",void 0);a([m.property()],e.prototype,"y_coordinate",void 0);a([m.property()],e.prototype,"activated",void 0);a([m.property()],e.prototype,"layerVisibility",void 0);a([m.property()],e.prototype,"modifiedBase",void 0);a([m.property()],e.prototype,"ccWidget",void 0);a([m.property()],e.prototype,"results",void 0);a([m.property()],e.prototype,"mouse_track",
void 0);a([m.property()],e.prototype,"view_click",void 0);return e=a([m.subclass("widgets.App.ObstructionViewModel")],e)}(m.declared(g));k.default=g});